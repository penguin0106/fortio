<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Œ¶ŒøœÅœÑŒØŒø v{{.Version}} - Load Testing Tool</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="{{.ChartJSPath}}"></script>
  <script src="{{.Version}}/static/js/fortio_chart.js"></script>
  <link rel="icon" href="{{.Version}}/static/img/favicon.ico"/>
  <link rel="stylesheet" href="{{.Version}}/static/css/fortio.css">
</head>
{{template "header" .}}

<!-- Page Header -->
<div class="page-header">
  <div class="header-content">
    <h1>Œ¶ŒøœÅœÑŒØŒø <span class="version-badge">v{{.Version}}</span></h1>
    <p class="header-subtitle">üöÄ –í—ã—Å–æ–∫–æ–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ–µ –Ω–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</p>
    <div class="header-meta">
      <span class="meta-item">‚è±Ô∏è –†–∞–±–æ—Ç–∞–µ—Ç: {{.UpTime}}</span>
      <span class="meta-item">üìÖ –ó–∞–ø—É—Å–∫: {{.StartTime}}</span>
    </div>
  </div>
</div>

{{if .DoLoad}}
<!-- Running Test with Live Stats and Charts -->
<div class="form-section">
  <h3 class="section-title">üîÑ –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ç–µ—Å—Ç</h3>
  <p style="margin-bottom: 16px;"><strong>{{.Labels}}</strong> ‚Üí {{.TargetURL}}</p>
  
  <div id="running">
    <!-- Progress Bar -->
    <div style="margin-bottom: 24px;">
      <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
        <span id="progressText">–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è...</span>
        <span id="progressPercent">0%</span>
      </div>
      <progress id="progressBar" max="100" value="0" style="width: 100%; height: 16px;"></progress>
    </div>
    
    <!-- Live Stats Grid -->
    <div id="liveStats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-bottom: 24px;">
      <div class="stat-card">
        <div class="stat-value" id="statRequests">0</div>
        <div class="stat-label">–ó–∞–ø—Ä–æ—Å–æ–≤</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="statQPS">0</div>
        <div class="stat-label">–¢–µ–∫—É—â–∏–π QPS</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="statSuccess">0</div>
        <div class="stat-label">–£—Å–ø–µ—à–Ω—ã—Ö</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="statErrors">0</div>
        <div class="stat-label">–û—à–∏–±–æ–∫</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="statAvgLatency">0 ms</div>
        <div class="stat-label">Avg Latency</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="statMaxLatency">0 ms</div>
        <div class="stat-label">Max Latency</div>
      </div>
    </div>

    <!-- Kafka Metrics Chart with Filters -->
    <div class="chart-card" id="kafkaChartCard" style="margin-bottom: 24px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 12px;">
        <h4 style="margin: 0; color: var(--text-primary, #1e293b);">üìä Kafka Metrics</h4>
        <div id="kafkaMetricFilters" style="display: flex; flex-wrap: wrap; gap: 8px; font-size: 0.85rem;">
          <!-- Filters will be dynamically added -->
        </div>
      </div>
      <div style="position: relative; height: 280px;">
        <canvas id="kafkaMetricsChart"></canvas>
      </div>
      <div style="margin-top: 12px; display: flex; gap: 16px; align-items: center; flex-wrap: wrap;">
        <label style="font-size: 0.85rem; color: var(--text-secondary);">
          –í—Ä–µ–º—è: –æ—Ç <input type="number" id="kafkaTimeMin" style="width: 60px; padding: 4px; border-radius: 4px; border: 1px solid var(--border, #e2e8f0);" placeholder="0"> 
          –¥–æ <input type="number" id="kafkaTimeMax" style="width: 60px; padding: 4px; border-radius: 4px; border: 1px solid var(--border, #e2e8f0);" placeholder="–∞–≤—Ç–æ"> —Å–µ–∫
        </label>
        <button type="button" onclick="updateKafkaChartRange()" class="btn-secondary" style="padding: 4px 12px; font-size: 0.85rem;">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
      </div>
    </div>
    
    <!-- Consumer Metrics Charts (dynamically created) -->
    <div id="consumerChartsContainer" style="display: none; margin-bottom: 24px;">
      <h4 style="margin: 0 0 16px 0; color: var(--text-primary, #1e293b);">üì• Consumer Service Metrics</h4>
      <div style="margin-bottom: 12px; display: flex; gap: 16px; align-items: center; flex-wrap: wrap;">
        <label style="font-size: 0.85rem; color: var(--text-secondary);">
          –í—Ä–µ–º—è: –æ—Ç <input type="number" id="consumerTimeMin" style="width: 60px; padding: 4px; border-radius: 4px; border: 1px solid var(--border, #e2e8f0);" placeholder="0"> 
          –¥–æ <input type="number" id="consumerTimeMax" style="width: 60px; padding: 4px; border-radius: 4px; border: 1px solid var(--border, #e2e8f0);" placeholder="–∞–≤—Ç–æ"> —Å–µ–∫
        </label>
        <label style="font-size: 0.85rem; color: var(--text-secondary);">
          –®–∞–≥: <input type="number" id="consumerStep" style="width: 60px; padding: 4px; border-radius: 4px; border: 1px solid var(--border, #e2e8f0);" placeholder="–∞–≤—Ç–æ" min="1">
        </label>
        <button type="button" onclick="updateConsumerChartsRange()" class="btn-secondary" style="padding: 4px 12px; font-size: 0.85rem;">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
      </div>
      <div id="consumerChartsGrid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 16px;">
        <!-- Charts will be dynamically added here -->
      </div>
    </div>
    
    <button type="button" class="btn-secondary" onclick='stopTest()' style="margin-top: 8px;">
      ‚èπÔ∏è –ü—Ä–µ—Ä–≤–∞—Ç—å —Ç–µ—Å—Ç
    </button>
    
    <script>
    function stopTest() {
      var btn = event.target;
      btn.disabled = true;
      btn.textContent = '‚è≥ –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º...';
      
      var basePath = window.location.pathname.replace(/\/$/, '');
      var stopUrl = basePath + '/?stop=Stop&runid={{.RunID}}';
      console.log('Stopping test:', stopUrl);
      
      fetch(stopUrl).then(function(response) {
        console.log('Stop response:', response.status);
        btn.textContent = '‚úì –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ, –æ–∂–∏–¥–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã...';
        // Test will complete and show results on this page automatically
      }).catch(function(err) {
        console.error('Stop error:', err);
        btn.disabled = false;
        btn.textContent = '‚èπÔ∏è –ü—Ä–µ—Ä–≤–∞—Ç—å —Ç–µ—Å—Ç';
        alert('–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ç–µ—Å—Ç–∞: ' + err);
      });
    }
    </script>
  </div>
</div>

<style>
.stat-card {
  background: var(--bg-secondary, #f1f5f9);
  padding: 16px;
  border-radius: 10px;
  text-align: center;
}
.stat-value {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--primary, #10b981);
}
.stat-label {
  font-size: 0.85rem;
  color: var(--text-secondary, #64748b);
}
.chart-card {
  background: var(--bg-card, #fff);
  border: 1px solid var(--border, #e2e8f0);
  border-radius: 12px;
  padding: 16px;
  margin-top: 4px;
}
</style>

<script>
// Connect to SSE for live progress updates
var runID = {{.RunID}};
var eventSource = null;
var pollingInterval = null;
var sseConnected = false;

// Get base URL for API calls
var baseUrl = window.location.pathname.replace(/\/$/, '');

function connectSSE() {
  if (eventSource) {
    eventSource.close();
  }
  
  // Use absolute path based on current location
  var sseUrl = baseUrl + '/progress/sse?runid=' + runID;
  console.log('Connecting to SSE:', sseUrl);
  
  try {
    eventSource = new EventSource(sseUrl);
    
    eventSource.onopen = function() {
      console.log('SSE connected');
      sseConnected = true;
      // Stop polling if it was running
      if (pollingInterval) {
        clearInterval(pollingInterval);
        pollingInterval = null;
      }
    };
    
    eventSource.onmessage = function(event) {
      try {
        var data = JSON.parse(event.data);
        updateLiveStats(data);
      } catch (e) {
        console.error('Failed to parse SSE data:', e);
      }
    };
    
    eventSource.onerror = function(err) {
      console.log('SSE error, falling back to polling');
      eventSource.close();
      sseConnected = false;
      startPolling();
    };
  } catch (e) {
    console.log('SSE not supported, using polling');
    startPolling();
  }
}

function startPolling() {
  if (pollingInterval) return;
  
  var apiUrl = baseUrl + '/progress/api?runid=' + runID;
  console.log('Starting polling:', apiUrl);
  
  pollingInterval = setInterval(function() {
    fetch(apiUrl)
      .then(function(response) { return response.json(); })
      .then(function(data) {
        if (data.status !== 'not_found') {
          updateLiveStats(data);
        }
      })
      .catch(function(err) {
        console.log('Polling error:', err);
      });
  }, 300);
}

// Live charts
var kafkaMetricsChart = null;
var consumerCharts = {}; // Map of metric name to chart
var chartsInitialized = false;
var activeKafkaMetrics = {}; // Which metrics are enabled in the filter
var lastKafkaMetrics = []; // Store last data for filtering
var lastConsumerServices = []; // Store last data for filtering (multiple services)

function initLiveCharts() {
  if (chartsInitialized) return;
  if (typeof Chart === 'undefined') {
    console.log('Chart.js not loaded yet, retrying...');
    setTimeout(initLiveCharts, 100);
    return;
  }
  
  // Kafka Metrics Chart (multi-line)
  var kafkaCtx = document.getElementById('kafkaMetricsChart');
  if (kafkaCtx) {
    kafkaMetricsChart = new Chart(kafkaCtx.getContext('2d'), {
      type: 'line',
      data: { datasets: [] },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: { duration: 0 },
        interaction: { mode: 'index', intersect: false },
        scales: {
          x: {
            type: 'linear',
            title: { display: true, text: '–í—Ä–µ–º—è (—Å–µ–∫)' },
            min: 0
          },
          y: { beginAtZero: true }
        },
        plugins: {
          legend: { 
            display: true, 
            position: 'bottom',
            labels: { usePointStyle: true, padding: 15 }
          },
          tooltip: { mode: 'index', intersect: false }
        }
      }
    });
  }
  
  chartsInitialized = true;
  console.log('Live charts initialized');
}

function updateKafkaFilters(metrics) {
  var container = document.getElementById('kafkaMetricFilters');
  if (!container) return;
  
  metrics.forEach(function(m) {
    if (document.getElementById('filter-' + m.name)) return; // Already exists
    
    // Initialize as active
    if (activeKafkaMetrics[m.name] === undefined) {
      activeKafkaMetrics[m.name] = true;
    }
    
    var label = document.createElement('label');
    label.style.cssText = 'display: flex; align-items: center; gap: 4px; cursor: pointer; padding: 4px 8px; border-radius: 4px; background: var(--bg-secondary, #f1f5f9);';
    label.innerHTML = '<input type="checkbox" id="filter-' + m.name + '" ' + (activeKafkaMetrics[m.name] ? 'checked' : '') + ' onchange="toggleKafkaMetric(\'' + m.name + '\')"> ' +
      '<span style="width: 12px; height: 12px; border-radius: 50%; background: ' + m.color + ';"></span> ' + m.label;
    container.appendChild(label);
  });
}

function toggleKafkaMetric(name) {
  activeKafkaMetrics[name] = !activeKafkaMetrics[name];
  if (lastKafkaMetrics.length > 0) {
    updateKafkaChart(lastKafkaMetrics);
  }
}

function updateKafkaChart(metrics) {
  if (!kafkaMetricsChart) return;
  lastKafkaMetrics = metrics;
  
  var timeMin = parseFloat(document.getElementById('kafkaTimeMin').value) || 0;
  var timeMax = parseFloat(document.getElementById('kafkaTimeMax').value) || null;
  
  var datasets = [];
  metrics.forEach(function(m) {
    if (!activeKafkaMetrics[m.name]) return;
    
    var filteredPoints = m.points.filter(function(p) {
      return p.t >= timeMin && (timeMax === null || p.t <= timeMax);
    });
    
    datasets.push({
      label: m.label + (m.unit ? ' (' + m.unit + ')' : ''),
      data: filteredPoints.map(function(p) { return { x: p.t, y: p.v }; }),
      borderColor: m.color,
      backgroundColor: m.color + '20',
      fill: false,
      tension: 0.3,
      pointRadius: 1,
      borderWidth: 2
    });
  });
  
  kafkaMetricsChart.data.datasets = datasets;
  if (timeMin > 0) kafkaMetricsChart.options.scales.x.min = timeMin;
  if (timeMax) kafkaMetricsChart.options.scales.x.max = timeMax;
  kafkaMetricsChart.update('none');
}

function updateKafkaChartRange() {
  if (lastKafkaMetrics.length > 0) {
    updateKafkaChart(lastKafkaMetrics);
  }
}

function updateConsumerCharts(services) {
  if (!services || services.length === 0) return;
  lastConsumerServices = services;
  
  var container = document.getElementById('consumerChartsContainer');
  var grid = document.getElementById('consumerChartsGrid');
  if (!container || !grid) return;
  
  container.style.display = 'block';
  
  var timeMin = parseFloat(document.getElementById('consumerTimeMin').value) || 0;
  var timeMax = parseFloat(document.getElementById('consumerTimeMax').value) || null;
  var step = parseInt(document.getElementById('consumerStep').value) || 1;
  
  // Process each service
  services.forEach(function(svc) {
    if (!svc.metrics || svc.metrics.length === 0) return;
    
    // Create or find service section
    var sectionId = 'consumer-section-' + svc.name.replace(/[^a-zA-Z0-9]/g, '_');
    var existingSection = document.getElementById(sectionId);
    
    // Determine badge style based on type
    var isFunction = svc.type === 'function';
    var badgeStyle = isFunction 
      ? 'background: linear-gradient(135deg, #8b5cf6, #6366f1);' 
      : 'background: #10b981;';
    var typeLabel = isFunction ? '‚ö° Lambda' : 'üîß –°–µ—Ä–≤–∏—Å';
    var nameDisplay = svc.function ? svc.name + ' (' + svc.function + ')' : svc.name;
    
    if (!existingSection) {
      // Create section for this service
      var section = document.createElement('div');
      section.id = sectionId;
      section.className = 'consumer-service-section';
      section.style.cssText = 'margin-bottom: 24px; padding: 16px; background: var(--bg-secondary, #f8fafc); border-radius: 8px;';
      section.innerHTML = '<h5 style="margin: 0 0 12px 0; color: var(--text-primary, #1e293b); font-size: 1rem; display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">' +
        '<span style="' + badgeStyle + ' color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem;">' + typeLabel + '</span>' +
        '<span style="font-weight: 600;">' + nameDisplay + '</span>' +
        '<span style="font-size: 0.8rem; color: var(--text-secondary);">' + svc.url + '</span></h5>' +
        '<div id="' + sectionId + '-charts" class="charts-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px;"></div>';
      grid.appendChild(section);
    }
    
    var chartsContainer = document.getElementById(sectionId + '-charts');
    if (!chartsContainer) return;
    
    // Process metrics for this service
    svc.metrics.forEach(function(m) {
      var chartKey = svc.name + '_' + m.name;
      var chartId = 'consumer-chart-' + chartKey.replace(/[^a-zA-Z0-9]/g, '_');
      var existingCard = document.getElementById('card-' + chartId);
      
      if (!existingCard) {
        // Create new chart card
        var card = document.createElement('div');
        card.id = 'card-' + chartId;
        card.className = 'chart-card';
        card.innerHTML = '<h6 style="margin: 0 0 8px 0; color: var(--text-primary, #1e293b); font-size: 0.9rem;">' + m.name + '</h6>' +
          '<div style="position: relative; height: 160px;"><canvas id="' + chartId + '"></canvas></div>';
        chartsContainer.appendChild(card);
        
        // Initialize chart
        var ctx = document.getElementById(chartId);
        if (ctx) {
          consumerCharts[chartKey] = new Chart(ctx.getContext('2d'), {
            type: 'line',
            data: { datasets: [] },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              animation: { duration: 0 },
              scales: {
                x: { type: 'linear', title: { display: true, text: '–í—Ä–µ–º—è (—Å–µ–∫)' }, min: 0 },
                y: { beginAtZero: true }
              },
              plugins: { legend: { display: false } }
            }
          });
        }
      }
      
      // Update chart data
      var chart = consumerCharts[chartKey];
      if (chart) {
        var filteredPoints = m.points.filter(function(p, i) {
          return p.t >= timeMin && (timeMax === null || p.t <= timeMax) && (i % step === 0);
        });
        
        chart.data.datasets = [{
          label: m.name,
          data: filteredPoints.map(function(p) { return { x: p.t, y: p.v }; }),
          borderColor: m.color,
          backgroundColor: m.color + '20',
          fill: true,
          tension: 0.3,
          pointRadius: 1,
          borderWidth: 2
        }];
        if (timeMin > 0) chart.options.scales.x.min = timeMin;
        if (timeMax) chart.options.scales.x.max = timeMax;
        chart.update('none');
      }
    });
  });
}

function updateConsumerChartsRange() {
  if (lastConsumerServices.length > 0) {
    updateConsumerCharts(lastConsumerServices);
  }
}

function updateLiveStats(data) {
  // Initialize charts if not done
  if (!chartsInitialized) {
    initLiveCharts();
  }
  
  // Update progress bar
  var progressBar = document.getElementById('progressBar');
  var progressPercent = document.getElementById('progressPercent');
  var progressText = document.getElementById('progressText');
  
  if (progressBar) {
    progressBar.value = data.progressPercent || 0;
  }
  if (progressPercent) {
    progressPercent.textContent = (data.progressPercent || 0).toFixed(0) + '%';
  }
  if (progressText) {
    var elapsed = (data.elapsedSeconds || 0).toFixed(1);
    progressText.textContent = '–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è ' + elapsed + 's...';
  }
  
  // Update stats cards
  var el;
  el = document.getElementById('statRequests');
  if (el) el.textContent = formatNumber(data.requestsTotal || 0);
  
  el = document.getElementById('statQPS');
  if (el) el.textContent = (data.currentQps || 0).toFixed(1);
  
  el = document.getElementById('statSuccess');
  if (el) el.textContent = formatNumber(data.requestsSuccess || 0);
  
  el = document.getElementById('statErrors');
  if (el) {
    el.textContent = formatNumber(data.requestsError || 0);
    if (data.requestsError > 0) {
      el.style.color = '#ef4444';
    }
  }
  
  el = document.getElementById('statAvgLatency');
  if (el) el.textContent = (data.latencyAvg || 0).toFixed(2) + ' ms';
  
  el = document.getElementById('statMaxLatency');
  if (el) el.textContent = (data.latencyMax || 0).toFixed(2) + ' ms';
  
  // Update Kafka metrics chart
  if (data.kafkaMetrics && data.kafkaMetrics.length > 0) {
    updateKafkaFilters(data.kafkaMetrics);
    updateKafkaChart(data.kafkaMetrics);
  }
  
  // Update Consumer services metrics charts
  if (data.consumerServices && data.consumerServices.length > 0) {
    updateConsumerCharts(data.consumerServices);
  }
}

function formatNumber(n) {
  if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
  if (n >= 1000) return (n / 1000).toFixed(1) + 'K';
  return n.toString();
}

// Initialize charts after Chart.js is loaded
setTimeout(initLiveCharts, 100);

// Start SSE connection
connectSSE();

// Fallback: also run the duration timer
runTestForDuration({{.TestExpectedDurationSeconds}});
</script>

<div class="chart-container" id="cc1" style="position: relative; height:75vh; width:100%; display:none;">
  <canvas id="chart1"></canvas>
</div>

<div id="update" class="chart-options" style="visibility: hidden">
  <form id="updtForm" action="javascript:updateChart()">
    <input type="submit" value="–û–±–Ω–æ–≤–∏—Ç—å" class="btn-secondary" />
    X: –º–∏–Ω <input type="text" name="xmin" size="5" />
    –º–∞–∫—Å <input type="text" name="xmax" size="5" /> –º—Å
    <label><input name="xlog" type="checkbox" onclick="updateChart()" /> –õ–æ–≥</label>
    &nbsp;|&nbsp;
    Y: –º–∏–Ω <input type="text" name="ymin" size="5" />
    –º–∞–∫—Å <input type="text" name="ymax" size="5" />
    <label><input name="ylog" type="checkbox" onclick="updateChart()" /> –õ–æ–≥</label>
  </form>
</div>
<pre>{{else}}
{{if .DoStop}}
<div class="form-section" style="text-align: center;">
  <h3 class="section-title">‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤...</h3>
</div>
{{else}}

<!-- Main Form -->
<form id="run-form" method="GET" onsubmit="checkPayload()">
  <div class="form-container">
    
    <!-- Basic Settings -->
    <div class="form-section">
      <h3 class="section-title">üìã –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
      
      <div class="form-group">
        <label class="form-label">
          <span class="label-text">–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–µ—Å—Ç–∞</span>
          <input type="text" name="labels" class="form-input" value="Fortio" />
          <span class="form-hint">–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</span>
        </label>
      </div>
      
      <div class="form-group" id="url-field-group">
        <label class="form-label">
          <span class="label-text">URL –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è</span>
          <input type="text" name="url" class="form-input" value="http://{{.URLHostPort}}/echo?delay=250us:30,5ms:5&status=503:0.5,429:1.5" />
          <span class="form-hint">–¶–µ–ª–µ–≤–æ–π URL –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</span>
        </label>
      </div>
    </div>

    <!-- Load Parameters -->
    <div class="form-section">
      <h3 class="section-title">‚ö° –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –Ω–∞–≥—Ä—É–∑–∫–∏</h3>
      
      <div class="form-row">
        <div class="form-group form-group-half">
          <label class="form-label">
            <span class="label-text">QPS (–∑–∞–ø—Ä–æ—Å–æ–≤/—Å–µ–∫)</span>
            <input type="text" name="qps" class="form-input" value="100" />
            <span class="form-hint">–¶–µ–ª–µ–≤–∞—è —á–∞—Å—Ç–æ—Ç–∞ –∑–∞–ø—Ä–æ—Å–æ–≤</span>
          </label>
        </div>
        <div class="form-group form-group-half">
          <label class="form-label">
            <span class="label-text">–°–æ–µ–¥–∏–Ω–µ–Ω–∏—è</span>
            <input type="text" name="c" class="form-input" value="10" />
            <span class="form-hint">–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –ø–æ—Ç–æ–∫–∏</span>
          </label>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">
          <span class="label-text">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</span>
          <div class="duration-options">
            <input id="duration" type="text" name="t" class="form-input form-input-small" value="3s" />
            <label class="checkbox-label">
              <input type="checkbox" name="t" onchange="toggleDuration(this)" />
              <span>–î–æ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è</span>
            </label>
            <span class="or-text">–∏–ª–∏</span>
            <input type="text" name="n" class="form-input form-input-small" value="" placeholder="N" />
            <span class="form-hint">–∑–∞–ø—Ä–æ—Å–æ–≤</span>
          </div>
        </label>
      </div>
    </div>

    <!-- Protocol Selection -->
    <div class="form-section">
      <h3 class="section-title">üåê –¢–∏–ø –Ω–∞–≥—Ä—É–∑–∫–∏</h3>
      
      <div class="protocol-tabs">
        <div class="tab-labels">
          <label class="tab-label active" data-tab="http" onclick="switchTab('http')">
            <span class="tab-icon">üåê</span>
            <span class="tab-text">HTTP / TCP / UDP</span>
          </label>
          <label class="tab-label" data-tab="grpc" onclick="switchTab('grpc')">
            <span class="tab-icon">‚ö°</span>
            <span class="tab-text">gRPC</span>
          </label>
          <label class="tab-label" data-tab="kafka" onclick="switchTab('kafka')">
            <span class="tab-icon">üì®</span>
            <span class="tab-text">Kafka</span>
          </label>
        </div>

        <!-- Hidden radio for form submission -->
        <input type="radio" name="runner" value="http" id="runner-http" checked style="display:none">
        <input type="radio" name="runner" value="grpc" id="runner-grpc" style="display:none">
        <input type="radio" name="runner" value="kafka" id="runner-kafka" style="display:none">

        <!-- HTTP Content -->
        <div class="tab-content active" id="content-http">
          <div class="load-block">
            <div class="load-block-header">
              <h4>HTTP / TCP / UDP</h4>
              <p class="load-block-desc">–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –≤–µ–±-–ø—Ä–æ—Ç–æ–∫–æ–ª—ã</p>
            </div>
            <div class="load-block-body">
              <div class="checkbox-group">
                <label class="checkbox-label">
                  <input type="checkbox" name="https-insecure" />
                  <span>HTTPS –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞</span>
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" name="stdclient" checked />
                  <span>–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π Go HTTP –∫–ª–∏–µ–Ω—Ç</span>
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" name="h2" />
                  <span>HTTP/2</span>
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" name="sequential-warmup" />
                  <span>–ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ–≥—Ä–µ–≤</span>
                </label>
              </div>
              <div class="form-group" style="margin-top: 16px;">
                <label class="form-label">
                  <span class="label-text">DNS Override</span>
                  <input type="text" name="resolve" class="form-input" placeholder="hostname:ip" />
                </label>
              </div>
            </div>
          </div>
        </div>

        <!-- gRPC Content -->
        <div class="tab-content" id="content-grpc">
          <div class="load-block">
            <div class="load-block-header">
              <h4>gRPC Load Testing</h4>
              <p class="load-block-desc">–í—ã—Å–æ–∫–æ–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω—ã–π RPC –ø—Ä–æ—Ç–æ–∫–æ–ª</p>
            </div>
            <div class="load-block-body">
              <div class="checkbox-group">
                <label class="checkbox-label">
                  <input type="checkbox" name="grpc-secure" />
                  <span>TLS –∑–∞—â–∏—Ç–∞</span>
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" name="ping" />
                  <span>Ping backend</span>
                </label>
              </div>
              <div class="form-row" style="margin-top: 16px;">
                <div class="form-group form-group-half">
                  <label class="form-label">
                    <span class="label-text">Ping delay</span>
                    <input type="text" name="grpc-ping-delay" class="form-input" value="0" />
                  </label>
                </div>
                <div class="form-group form-group-half">
                  <label class="form-label">
                    <span class="label-text">Health service</span>
                    <input type="text" name="healthservice" class="form-input" placeholder="Service name" />
                  </label>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Kafka Content -->
        <div class="tab-content" id="content-kafka">
          <div class="load-block load-block-kafka">
            <div class="load-block-header">
              <h4>üöÄ Kafka Load Testing</h4>
              <p class="load-block-desc">–ù–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Apache Kafka</p>
            </div>
            <div class="load-block-body">
              <div class="form-group">
                <label class="form-label">
                  <span class="label-text">Bootstrap Servers</span>
                  <input type="text" name="kafka-bootstrap" id="kafka-bootstrap" class="form-input" value="kafka:9092" />
                  <span class="form-hint">–ê–¥—Ä–µ—Å–∞ –±—Ä–æ–∫–µ—Ä–æ–≤ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é</span>
                </label>
              </div>
              <div class="form-group">
                <label class="form-label">
                  <span class="label-text">Topic</span>
                  <input type="text" name="kafka-topic" id="kafka-topic" class="form-input" value="test-topic" />
                </label>
              </div>
              <label class="checkbox-label">
                <input type="checkbox" name="kafka-metrics" />
                <span>–°–æ–±–∏—Ä–∞—Ç—å –º–µ—Ç—Ä–∏–∫–∏ Kafka</span>
              </label>
              <div class="form-group" style="margin-top: 16px;">
                <label class="form-label">
                  <span class="label-text">Consumer Metrics Sources (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</span>
                  <span class="label-hint" style="font-size: 0.8rem; color: var(--text-secondary);">–°–µ—Ä–≤–∏—Å—ã –∏–ª–∏ Lambda —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Å–±–æ—Ä–∞ –º–µ—Ç—Ä–∏–∫</span>
                </label>
                <div id="consumer-services-list">
                  <!-- Consumer services will be added here dynamically -->
                </div>
                <div style="display: flex; gap: 8px; margin-top: 8px;">
                  <button type="button" class="btn btn-secondary btn-sm" onclick="addConsumerService('service')">
                    + –°–µ—Ä–≤–∏—Å
                  </button>
                  <button type="button" class="btn btn-secondary btn-sm" onclick="addConsumerService('function')" style="background: linear-gradient(135deg, #8b5cf6, #6366f1); color: white;">
                    + Lambda —Ñ—É–Ω–∫—Ü–∏—è
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Advanced Options (Collapsible) -->
    <div class="form-section form-section-collapsible">
      <h3 class="section-title" onclick="toggleSection(this)">
        <span>üîß –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</span>
        <span class="toggle-icon">‚ñ∂</span>
      </h3>
      <div class="section-content" style="display: none;">
        
        <div class="form-row">
          <div class="form-group form-group-half">
            <label class="form-label">
              <span class="label-text">–ü—Ä–æ—Ü–µ–Ω—Ç–∏–ª–∏</span>
              <input type="text" name="p" class="form-input" value="50, 75, 90, 99, 99.9" />
            </label>
          </div>
          <div class="form-group form-group-half">
            <label class="form-label">
              <span class="label-text">–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –≥–∏—Å—Ç–æ–≥—Ä–∞–º–º—ã</span>
              <input type="text" name="r" class="form-input" value="0.0001" />
            </label>
          </div>
        </div>

        <div class="form-group">
          <span class="label-text">–û–ø—Ü–∏–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</span>
          <div class="checkbox-group" style="margin-top: 8px;">
            <label class="checkbox-label">
              <input type="checkbox" name="log-errors" checked />
              <span>–õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –æ—à–∏–±–∫–∏</span>
            </label>
            <label class="checkbox-label">
              <input type="checkbox" name="uniform" checked />
              <span>–†–∞–≤–Ω–æ–º–µ—Ä–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ</span>
            </label>
            <label class="checkbox-label">
              <input type="checkbox" name="jitter" />
              <span>Jitter</span>
            </label>
            <label class="checkbox-label">
              <input type="checkbox" name="nocatchup" checked />
              <span>–ë–µ–∑ –¥–æ–≥–æ–Ω—è–Ω–∏—è</span>
            </label>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">
            <span class="label-text">–ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π</span>
            <div class="form-row" style="margin-top: 8px;">
              <input type="text" name="connection-reuse-range-min" class="form-input form-input-small" placeholder="–ú–∏–Ω" />
              <span class="form-separator">‚Äî</span>
              <input type="text" name="connection-reuse-range-max" class="form-input form-input-small" placeholder="–ú–∞–∫—Å" />
              <span class="or-text">–∏–ª–∏</span>
              <input type="text" name="connection-reuse-range-value" class="form-input form-input-small" placeholder="–ó–Ω–∞—á–µ–Ω–∏–µ" />
            </div>
          </label>
        </div>

        <div class="form-row">
          <div class="form-group form-group-half">
            <label class="form-label">
              <span class="label-text">HTTP –º–µ—Ç–æ–¥</span>
              <input type="text" name="X" class="form-input" placeholder="GET, POST, PUT..." />
            </label>
          </div>
          <div class="form-group form-group-half">
            <label class="form-label">
              <span class="label-text">–¢–∞–π–º–∞—É—Ç</span>
              <input type="text" name="timeout" class="form-input" value="750ms" />
            </label>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">
            <span class="label-text">HTTP –∑–∞–≥–æ–ª–æ–≤–∫–∏</span>
            <div class="header-input-group">
              <input type="text" name="H" class="form-input" placeholder="Header: Value" />
              <button type="button" class="btn-icon" onclick="addCustomHeader()" title="–î–æ–±–∞–≤–∏—Ç—å">+</button>
            </div>
          </label>
        </div>

        <div class="form-group">
          <label class="form-label">
            <span class="label-text">Payload</span>
            <textarea name="payload" id="payload" class="form-textarea" placeholder='{"key": "value"}'></textarea>
          </label>
        </div>
      </div>
    </div>

    <!-- Output Options -->
    <div class="form-section">
      <h3 class="section-title">üíæ –í—ã–≤–æ–¥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</h3>
      <div class="checkbox-group">
        <label class="checkbox-label">
          <input type="checkbox" name="json" />
          <span>–¢–æ–ª—å–∫–æ JSON</span>
        </label>
        <label class="checkbox-label">
          <input type="checkbox" name="save" checked />
          <span>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</span>
        </label>
      </div>
    </div>

    <!-- Submit -->
    <div style="margin-top: 24px;">
      <button type="submit" name="load" value="Start" class="btn-primary btn-large">
        ‚ñ∂Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç
      </button>
    </div>
  </div>
</form>

<!-- JavaScript -->
<script>
function switchTab(tabName) {
  // Update tab labels
  document.querySelectorAll('.tab-label').forEach(function(label) {
    label.classList.remove('active');
    if (label.dataset.tab === tabName) {
      label.classList.add('active');
    }
  });
  
  // Update tab content
  document.querySelectorAll('.tab-content').forEach(function(content) {
    content.classList.remove('active');
  });
  document.getElementById('content-' + tabName).classList.add('active');
  
  // Update hidden radio
  document.getElementById('runner-' + tabName).checked = true;
  
  // Toggle URL field for Kafka
  var urlField = document.getElementById('url-field-group');
  if (tabName === 'kafka') {
    urlField.style.display = 'none';
  } else {
    urlField.style.display = '';
  }
}

function toggleSection(element) {
  var section = element.closest('.form-section-collapsible');
  var content = section.querySelector('.section-content');
  var icon = element.querySelector('.toggle-icon');
  
  if (content.style.display === 'none') {
    content.style.display = 'block';
    icon.textContent = '‚ñº';
  } else {
    content.style.display = 'none';
    icon.textContent = '‚ñ∂';
  }
}

function toggleKafkaFields() {
  // Legacy function for compatibility
}

var consumerServiceCount = 0;

function addConsumerService(type, prefill) {
  prefill = prefill || {};
  var list = document.getElementById('consumer-services-list');
  var id = 'consumer-' + (++consumerServiceCount);
  var div = document.createElement('div');
  div.className = 'consumer-service-item';
  div.id = id;
  div.style.cssText = 'padding: 12px; margin-bottom: 12px; border: 1px solid var(--border, #e2e8f0); border-radius: 8px; background: var(--bg-secondary, #f8fafc);';
  
  if (type === 'service') {
    div.innerHTML = 
      '<input type="hidden" name="consumer-type[]" value="service">' +
      '<div style="display: flex; gap: 8px; align-items: center; margin-bottom: 8px;">' +
        '<span style="background: #10b981; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem;">–°–µ—Ä–≤–∏—Å</span>' +
        '<button type="button" class="btn btn-danger btn-sm" onclick="removeConsumerService(\'' + id + '\')" style="margin-left: auto; padding: 2px 8px;">‚úï</button>' +
      '</div>' +
      '<div style="display: grid; grid-template-columns: 1fr 2fr; gap: 8px;">' +
        '<input type="text" name="consumer-name[]" class="form-input" placeholder="–ò–º—è (–Ω–∞–ø—Ä. my-service)" value="' + (prefill.name || '') + '" required />' +
        '<input type="text" name="consumer-url[]" class="form-input" placeholder="http://service:8080/metrics" value="' + (prefill.url || '') + '" required />' +
      '</div>' +
      '<input type="hidden" name="consumer-function[]" value="">' +
      '<input type="hidden" name="consumer-namespace[]" value="">' +
      '<input type="hidden" name="consumer-autodiscover[]" value="false">';
  } else {
    // Lambda function
    div.innerHTML = 
      '<input type="hidden" name="consumer-type[]" value="function">' +
      '<div style="display: flex; gap: 8px; align-items: center; margin-bottom: 8px;">' +
        '<span style="background: linear-gradient(135deg, #8b5cf6, #6366f1); color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem;">Lambda</span>' +
        '<button type="button" class="btn btn-danger btn-sm" onclick="removeConsumerService(\'' + id + '\')" style="margin-left: auto; padding: 2px 8px;">‚úï</button>' +
      '</div>' +
      '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;">' +
        '<input type="text" name="consumer-name[]" class="form-input" placeholder="–û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è" value="' + (prefill.name || '') + '" required />' +
        '<input type="text" name="consumer-function[]" class="form-input" placeholder="–ò–º—è —Ñ—É–Ω–∫—Ü–∏–∏ (–Ω–∞–ø—Ä. my-function)" value="' + (prefill.function || '') + '" required />' +
      '</div>' +
      '<div style="display: grid; grid-template-columns: 1fr auto; gap: 8px; align-items: center;">' +
        '<input type="text" name="consumer-url[]" class="form-input" placeholder="URL –º–µ—Ç—Ä–∏–∫ (–∏–ª–∏ –æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –∞–≤—Ç–æ)" value="' + (prefill.url || '') + '" />' +
        '<label style="display: flex; align-items: center; gap: 4px; white-space: nowrap; cursor: pointer;">' +
          '<input type="checkbox" name="consumer-autodiscover[]" value="true" ' + (prefill.autodiscover ? 'checked' : '') + ' onchange="toggleFunctionUrlField(this)">' +
          '<span style="font-size: 0.85rem;">–ê–≤—Ç–æ</span>' +
        '</label>' +
      '</div>' +
      '<div style="margin-top: 8px;">' +
        '<input type="text" name="consumer-namespace[]" class="form-input" placeholder="Namespace (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏–∑ ENV)" value="' + (prefill.namespace || '') + '" style="font-size: 0.85rem;" />' +
        '<span style="font-size: 0.75rem; color: var(--text-secondary);">–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è FUNCTION_NAMESPACE –∏–∑ ENV</span>' +
      '</div>';
  }
  
  list.appendChild(div);
}

function removeConsumerService(id) {
  var el = document.getElementById(id);
  if (el) el.remove();
}

function toggleFunctionUrlField(checkbox) {
  var container = checkbox.closest('.consumer-service-item');
  var urlInput = container.querySelector('input[name="consumer-url[]"]');
  if (checkbox.checked) {
    urlInput.disabled = true;
    urlInput.placeholder = '–ë—É–¥–µ—Ç –æ–ø—Ä–µ–¥–µ–ª—ë–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏';
    urlInput.value = '';
  } else {
    urlInput.disabled = false;
    urlInput.placeholder = 'URL –º–µ—Ç—Ä–∏–∫';
  }
}

document.addEventListener('DOMContentLoaded', function() {
  // Initialize
});
</script>

<!-- Quick Links -->
<div class="quick-links">
  <h3>üîó –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h3>
  <div class="links-grid">
    <a href="browse" class="link-card">
      <span class="link-card-title">üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤</span>
      <span class="link-card-desc">–ü—Ä–æ—Å–º–æ—Ç—Ä —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</span>
    </a>
    <a href="data/" class="link-card">
      <span class="link-card-title">üìÅ Raw JSON</span>
      <span class="link-card-desc">JSON —Ñ–∞–π–ª—ã —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</span>
    </a>
    <a href="{{.DebugPath}}" class="link-card">
      <span class="link-card-title">üêõ Debug</span>
      <span class="link-card-desc">–û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</span>
    </a>
    <a href="{{.MetricsPath}}" class="link-card">
      <span class="link-card-title">üìà –ú–µ—Ç—Ä–∏–∫–∏</span>
      <span class="link-card-desc">Prometheus –º–µ—Ç—Ä–∏–∫–∏</span>
    </a>
    <a href="flags" class="link-card">
      <span class="link-card-title">üö© –§–ª–∞–≥–∏</span>
      <span class="link-card-desc">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—É—Å–∫–∞</span>
    </a>
    <a href="{{.EchoDebugPath}}" class="link-card">
      <span class="link-card-title">üîä Echo</span>
      <span class="link-card-desc">Echo —ç–Ω–¥–ø–æ–∏–Ω—Ç</span>
    </a>
  </div>
</div>

<!-- Utility Sections -->
<div class="utility-section">
  <h4>üîç DNS Resolve</h4>
  <form action="rest/dns" class="utility-form">
    <input type="text" name="name" placeholder="example.com" />
    <input type="submit" value="Resolve" />
  </form>
</div>

<div class="utility-section">
  <h4>üåê Debug Fetch</h4>
  <form action="fetch2/" class="utility-form">
    <input type="text" name="url" placeholder="https://example.com" />
    <input type="submit" value="Fetch" />
  </form>
</div>

<div class="utility-section">
  <h4>üì• Sync Data</h4>
  <form action="sync" class="utility-form">
    <input type="text" name="url" placeholder="S3 bucket URL" />
    <input type="submit" value="Sync" />
  </form>
</div>

<div class="utility-section">
  <h4>‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ —Ç–µ—Å—Ç—ã</h4>
  <form method="POST" class="utility-form">
    <input type="submit" name="stop" value="Stop All" style="background: #ef4444;" />
  </form>
</div>

{{end}}
{{end}}

<!-- Footer -->
<div class="page-footer">
  <p>Fortio {{.LongVersion}}</p>
  <p><a href="https://fortio.org/" target="_blank">–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è</a> ¬∑ <a href="https://github.com/fortio/fortio" target="_blank">GitHub</a></p>
</div>

</body>
</html>
